# Upload Stage

stages:
- stage: Upload
  dependsOn:
  - Build
  jobs:
  - job: Upload
    templateContext:
      outputs:
      - output: nuget
        displayName: 'Push Packages'
        condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['PushPackages'], 'true')))
        packageParentPath: '$(Build.ArtifactStagingDirectory)'
        packagesToPush: $(Build.ArtifactStagingDirectory)/package/*.nupkg
        nuGetFeedType: external
        publishFeedCredentials: 'xamarin-impl public feed'
    steps:
    - checkout: self

    - task: UseDotNet@2
      inputs:
        packageType: runtime
        version: $(DotNetVersion)
        performMultiLevelLookup: true
    - script: 'dotnet tool update -g --version 7.0.0 PowerShell >nul || dotnet tool list -g'
      displayName: UsePowerShell

    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: package
        targetPath: $(Build.ArtifactStagingDirectory)/package

    - template: upload-to-storage/win/v1.yml@templates
      parameters:
        ArtifactsDirectory: '$(Build.ArtifactStagingDirectory)/package'
        Azure.ContainerName: 'xvs-merq'
        GitHub.Context: 'artifacts'